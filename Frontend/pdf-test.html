<!DOCTYPE html>
<html lang="en">
<head>
  <script id="dom-sniffer-script" src="http://localhost:3000/public/dom-sniffer.js" async></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>jsPDF Test</title>
    <!-- jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-content {
            background: white;
            padding: 40px;
            border: 1px solid #ddd;
            margin: 20px 0;
        }
        .test-image {
            max-width: 300px;
            height: auto;
            margin: 10px 0;
            border: 1px solid #ccc;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>jsPDF Test Page</h1>
    
    <div class="test-content" id="content-to-pdf">
        <h2>Test Blog Content</h2>
        <p>This is a test blog post to verify jsPDF functionality.</p>
        
        <h3>Sample Content</h3>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
        
        <h3>Test Images</h3>
        <p>Below are some test images:</p>
        
        <!-- Local image -->
        <img src="./assets/placeholder.svg" alt="Local Placeholder" class="test-image">
        
        <!-- External image -->
        <img src="https://via.placeholder.com/300x200/0000FF/FFFFFF?text=Test+Image" alt="External Test Image" class="test-image">
        
        <h3>More Content</h3>
        <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
        
        <ul>
            <li>First item in the list</li>
            <li>Second item with <strong>bold text</strong></li>
            <li>Third item with <em>italic text</em></li>
        </ul>
        
        <p>This concludes our test content for PDF generation.</p>
    </div>
    
    <button onclick="generatePDF()">Generate PDF</button>
    <button onclick="clearLog()">Clear Log</button>
    
    <div id="log" class="log"></div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function generatePDF() {
            log('Starting PDF generation...');
            
            try {
                // Check if jsPDF is available
                if (typeof window.jsPDF === 'undefined') {
                    throw new Error('jsPDF library not loaded');
                }
                
                log('jsPDF library loaded successfully');
                
                // Get the content to convert
                const contentElement = document.getElementById('content-to-pdf');
                
                // Process images first
                const images = contentElement.querySelectorAll('img');
                log(`Found ${images.length} images to process`);
                
                // Convert images to base64
                for (let i = 0; i < images.length; i++) {
                    const img = images[i];
                    log(`Processing image ${i + 1}/${images.length}: ${img.src}`);
                    
                    try {
                        // Wait for image to load
                        if (!img.complete || img.naturalHeight === 0) {
                            await new Promise((resolve, reject) => {
                                img.onload = resolve;
                                img.onerror = reject;
                                setTimeout(() => reject(new Error('Image load timeout')), 10000);
                            });
                        }
                        
                        // Convert to base64
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.naturalWidth || img.width;
                        canvas.height = img.naturalHeight || img.height;
                        ctx.drawImage(img, 0, 0);
                        
                        const base64 = canvas.toDataURL('image/jpeg', 0.8);
                        img.src = base64;
                        log(`Successfully converted image ${i + 1} to base64`);
                        
                    } catch (error) {
                        log(`Failed to process image ${i + 1}: ${error.message}`);
                        // Replace with placeholder
                        img.src = './assets/placeholder.svg';
                    }
                }
                
                log('All images processed, generating canvas...');
                
                // Generate canvas from HTML
                const canvas = await html2canvas(contentElement, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    letterRendering: true,
                    logging: false,
                    imageTimeout: 15000
                });
                
                log('Canvas generated successfully');
                
                // Create PDF
                const { jsPDF } = window.jsPDF;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 295; // A4 height in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                log(`Canvas dimensions: ${canvas.width}x${canvas.height}`);
                log(`PDF dimensions: ${imgWidth}mm x ${imgHeight}mm`);
                
                // Add first page
                pdf.addImage(canvas, 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                // Add additional pages if needed
                let pageCount = 1;
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(canvas, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    pageCount++;
                }
                
                log(`PDF generated with ${pageCount} page(s)`);
                
                // Save the PDF
                pdf.save('test-blog-content.pdf');
                log('PDF downloaded successfully!');
                
            } catch (error) {
                log(`Error: ${error.message}`);
                console.error('PDF generation error:', error);
            }
        }
        
        // Test on page load
        window.addEventListener('load', () => {
            log('Page loaded, ready for testing');
        });
    </script>
</body>
</html> 